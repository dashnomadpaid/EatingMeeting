# Carousel Stutter Fix - 2025-01-20 01:20

## Issue
User reported: "왜 캐러셀 넘길 때 끊기는 듯한 느낌이 들지?"
- Carousel felt stuttery/laggy when swiping between place cards
- Animation style was spring-based and should be preserved
- User specifically requested: "애니메이션 바꾸지 말고 끊기는 오류만 수정해"

## Root Cause Analysis
Located in `app/(tabs)/index.tsx` CarouselCard component (Lines 119-141):

**Problem:** useEffect was using immediate `setValue()` for non-active cards:
```typescript
useEffect(() => {
  if (isActive) {
    // Active card: smooth spring animation ✅
    Animated.spring(animatedScale, {...}).start();
    Animated.spring(animatedOpacity, {...}).start();
  } else {
    // Non-active card: immediate jump (causing stutter) ❌
    animatedScale.setValue(0.92);
    animatedOpacity.setValue(0.6);
  }
}, [isActive]);
```

**Why it caused stutter:**
- When user swiped, `isActive` changed for multiple cards simultaneously
- Active card smoothly animated via spring
- Non-active cards **instantly snapped** to reduced scale/opacity via setValue()
- This visual mismatch created the stuttering/jerky feel during swipe transitions

## Solution Implemented
**File:** `app/(tabs)/index.tsx`  
**Lines:** 119-141

Replaced immediate `setValue()` with smooth `Animated.timing()` for non-active cards:

```typescript
useEffect(() => {
  if (isActive) {
    // Active card: spring animation (preserved)
    Animated.spring(animatedScale, {
      toValue: 1,
      friction: 8,
      tension: 40,
      useNativeDriver: true,
    }).start();
    Animated.spring(animatedOpacity, {
      toValue: 1,
      friction: 8,
      tension: 40,
      useNativeDriver: true,
    }).start();
  } else {
    // Non-active card: smooth transition (fixed)
    Animated.timing(animatedScale, {
      toValue: 0.92,
      duration: 200,
      useNativeDriver: true,
    }).start();
    Animated.timing(animatedOpacity, {
      toValue: 0.6,
      duration: 200,
      useNativeDriver: true,
    }).start();
  }
}, [isActive, animatedScale, animatedOpacity]);
```

**Key changes:**
1. ❌ Removed: `animatedScale.setValue(0.92)` / `animatedOpacity.setValue(0.6)`
2. ✅ Added: `Animated.timing()` with 200ms duration for smooth transitions
3. ✅ Preserved: Spring animation (friction: 8, tension: 40) for active cards
4. ✅ Added: Dependencies `[isActive, animatedScale, animatedOpacity]` for proper hook behavior

## Technical Details

### FlatList Configuration (unchanged)
```typescript
const CARD_WIDTH = Math.min(WINDOW_WIDTH * 0.8, 320);
const CARD_SPACING = 16;
const CARD_PEEK_PADDING = (WINDOW_WIDTH - CARD_WIDTH) / 2;

<FlatList
  snapToInterval={CARD_WIDTH + CARD_SPACING}
  decelerationRate="fast"
  getItemLayout={getItemLayout}
  // ...
/>
```

### Animation Values
- **Scale:** 1.0 (active) ↔ 0.92 (inactive)
- **Opacity:** 1.0 (active) ↔ 0.6 (inactive)
- **Active animation:** Spring (friction: 8, tension: 40) - bouncy, natural feel
- **Inactive animation:** Timing (200ms) - smooth fade/scale-down

## Result
- ✅ Eliminated stuttering/jerky feel during carousel swipes
- ✅ Preserved spring animation style for active cards
- ✅ All card transitions now use animation system (no immediate setValue)
- ✅ Native driver optimization maintained for performance

## Related Context
- **Carousel specs:** Card width 80% screen (max 320px), 16px spacing
- **Place data source:** Google Places API via `services/places.google.ts`
- **State management:** `map.store.ts` selectedPlace, `useMap.ts` hook
- **Component hierarchy:** Discover screen → FlatList → CarouselCard → Animated.View

## Testing Notes
To validate fix:
1. Open Discover tab (지도 탭)
2. Switch to map view (하단 Map 버튼)
3. Swipe carousel left/right rapidly
4. Confirm smooth transitions without visual snapping/stuttering
5. Active card should still have bouncy spring animation

## Lesson Learned
**Always use `Animated.timing()` or `Animated.spring()` instead of `setValue()` for visual state changes.**  
Even when "hiding" or reducing prominence, immediate jumps break the illusion of smooth UI. Short duration animations (150-250ms) provide better UX than instant changes.

---
_Generated by GitHub Copilot - 2025-01-20 20:55_
